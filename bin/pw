#!/usr/bin/env zsh

# use fzf and bw cli to search bitwarden logins and copy password to clipboard

if ! test $(command -v bw); then
  echo "@bitwarden/cli not installed."
  exit 1
fi

object="$1"
if test -z "$object"; then
  object=password
fi

# unlock the vault if nexessary
if [[ -z "$BW_SESSION" ]]; then
  BW_SESSION=$(bw unlock --raw)
fi

if [[ -z $BW_SESSION ]]; then
  exit 1
fi

login=$(bw list items --session "$BW_SESSION" | jq '.[].name' | sed -E 's/(^"|"$)//g' | fzf)

if test -z "$login"; then
  return
fi

bw get "$object" "$login" --session "$BW_SESSION" | pbcopy | echo "$login $object copied to clipboard"
