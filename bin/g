#!/usr/bin/env zsh

# git status/add/diff all in one command

# enter: view full-screen diff
# tab: stage/unstage a file
# ctrl-a: stage all files
# ctrl-r: unstage all files
# ctrl-c: start a commit
# ctrl-b: switch from batdiff to regular diff
# alt-d: discard untracked changes
# alt-s: stash all


git rev-parse --is-inside-git-dir >/dev/null || return 1

git_status="git -c color.status=always status -sbu"

eval "$git_status" | fzf --no-sort --tiebreak=index --ansi --header-lines=1 \
  --preview="_git-diff {2}" \
  --bind="ctrl-/:preview(echo {2} | xargs bat --diff --diff-context=4 --color=always)" \
  --bind="enter:execute:_git-diff {2} | less -R" \
  --bind="tab:execute-silent(_git-stage-toggle {2})+reload($git_status)" \
  --bind="ctrl-a:execute-silent(git add -A)+reload($git_status)" \
  --bind="ctrl-r:execute-silent(git restore --staged .)+reload($git_status)" \
  --bind="ctrl-c:accept+execute(git commit)" \
  --bind="alt-d:execute-silent(git restore {2})+reload($git_status)" \
  --bind="alt-s:execute-silent(git stash -u)+accept"
